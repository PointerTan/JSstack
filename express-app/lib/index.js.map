{"version":3,"sources":["../src/index.js"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["import http from \"http\";\nimport { Layer } from \"../lib/layer\";\n\nexport default function () {\n    const app = function (req, res) {\n        app.req = req;\n        app.res = res;\n        app.nextIndex = 0;\n        app.next();\n    }\n\n    app.handle = function () {\n\n    }\n\n    app.originUrl = \"\";\n    app.hasFather = false;\n    app.isApp = true;\n\n    app.next = function (error) {\n        // console.log(app.nextIndex + \"aa\" + app.stack.length);\n\n        if (app.nextIndex === app.stack.length) {\n            if (app.hasFather) {\n                console.log(\"hasFather and end\");\n                app.req.url = app.req.originUrl;\n                app.father.next(error);\n                return;\n            }\n\n            if (error) {\n                app.res.statusCode = 500;\n                app.res.end(\"error\");\n                return;\n            }\n\n            app.res.statusCode = 404;\n            app.res.end(\"not found\");\n            return;\n        }\n\n        let hasError = false;\n        if (error) {\n            hasError = true;\n        }\n\n        try {\n            let useMethod;\n            do {\n                let tempUseM = app.stack[app.nextIndex];\n                app.nextIndex += 1;\n                if ((hasError && tempUseM.handle.length === 4) || (!hasError && tempUseM.handle.length !== 4)) {\n                    useMethod = tempUseM;\n                    break;\n                }\n            } while (app.nextIndex < app.stack.length);\n\n            let matchObj = useMethod.match(app.req.url);\n            let req = app.req;\n            if (matchObj) {\n                app.req.params = matchObj.params;\n                app.req.originUrl = req.url;\n                req.url = matchObj.url;\n            }\n            else {\n                // console.log(app.req.url)\n                app.req.params = {};\n            }\n\n            if (hasError) {\n                if (useMethod && matchObj) {\n                    useMethod.handle(error, req, app.res, app.next);\n                }\n                else {\n                    app.next(error);\n                }\n            }\n            else {\n                if (useMethod && matchObj) {\n                    useMethod.handle(req, app.res, app.next);\n                }\n                else {\n                    app.next();\n                }\n            }\n        } catch (error) {\n            app.next(error);\n            // app.res.statusCode = 500;\n            // app.res.end(\"error\");\n            return;\n        }\n    }\n\n    app.stack = [];\n\n    app.listen = function () {\n        const server = http.createServer(app);\n        server.listen(4000);\n    }\n\n    app.use = function (pathOrFunc, useFunc) {\n        var path = \"/\";\n        var func = pathOrFunc;\n        if (typeof pathOrFunc === 'string') {\n            path = pathOrFunc;\n            func = useFunc;\n        }\n\n        let layer = new Layer(path, func);\n\n        if (layer.handle && layer.handle.isApp) {\n            layer.handle.hasFather = true;\n            layer.handle.father = app;\n        }\n        app.stack.push(layer);\n    }\n\n    return app;\n}"]}